generator client {
  provider = "prisma-client-js"
  output   = "./generated"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Topic {
  id               String   @id @default(uuid())
  name             String
  userId           String
  parentId         String?
  moduleId         String?
  color            String?  // Color for UI display
  icon             String?  // Emoji or icon identifier
  difficulty       Int      @default(1)
  estimatedMinutes Int      @default(0)
  bloomsLevel      String   @default("remember")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  archivedAt DateTime?

  module           Module?            @relation(fields: [moduleId], references: [id])
  flashcards       Flashcard[]
  reviewLogs       ReviewLog[]
  subtopics        Subtopic[]
  quiz             Quiz[]
  
  prerequisites    TopicDependency[]  @relation("Prerequisites")
  dependents       TopicDependency[]  @relation("Dependents")
}

model Syllabus {
  id        String   @id @default(uuid())
  topicId   String   @unique
  content   String   // JSON structure of the syllabus
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Flashcard {
  id        String   @id @default(uuid())
  userId    String   // Owner of the flashcard
  topicId   String
  front     String
  back      String
  nextReview DateTime
  interval  Int
  easeFactor Float
  difficulty String  @default("NORMAL") // EASY, NORMAL, HARD
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  archivedAt DateTime?

  topic      Topic       @relation(fields: [topicId], references: [id], onDelete: Cascade)
  reviewLogs ReviewLog[]

  @@index([topicId, nextReview])
  @@index([userId, nextReview])
}

model ReviewLog {
  id          String   @id @default(uuid())
  userId      String
  flashcardId String
  topicId     String
  quality     Int      // 0-5
  easeFactor  Float
  interval    Int
  reviewedAt  DateTime @default(now())

  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  topic       Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@index([userId, reviewedAt])
  @@index([topicId])
}

model InterventionRule {
  id              String   @id @default(uuid())
  userId          String
  name            String
  description     String?
  triggerType     String   // TIME_BASED, APP_BASED, BEHAVIOR_BASED
  triggerCondition String  // JSON: condition definition
  actionType      String   // REDIRECT, NOTIFY, BLOCK, SUGGEST
  actionTarget    String   // URL, app, or content to redirect to
  priority        Int      @default(0)
  isActive        Boolean  @default(true)
  timesTriggered  Int      @default(0)
  successRate     Float?   // Percentage of successful interventions
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([userId, isActive])
}

model KaizenSession {
  id              String   @id @default(uuid())
  userId          String
  goalId          String?  // Reference to UserGoal
  sessionType     String   // FOCUS, LEARNING, REFLECTION, REVIEW
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  duration        Int?     // Minutes
  activitiesCount Int      @default(0)
  capturesCount   Int      @default(0)
  flashcardsCount Int      @default(0)
  productivityScore Float? // 0.0 - 1.0
  notes           String?
  mood            String?  // ENERGIZED, FOCUSED, TIRED, DISTRACTED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([userId, startedAt])
}

model MemoryInsight {
  id              String   @id @default(uuid())
  userId          String
  title           String
  description     String
  memoryType      String   // MILESTONE, STREAK, LEARNING_BURST, TOPIC_MASTERY, TIME_CAPSULE
  relatedIds      String   // JSON: IDs of related captures, topics, flashcards
  thumbnailUrl    String?
  startDate       DateTime
  endDate         DateTime?
  metrics         String?  // JSON: stats like "50 flashcards reviewed"
  sentiment       String   @default("POSITIVE") // POSITIVE, NEUTRAL, NOSTALGIC
  isViewed        Boolean  @default(false)
  viewedAt        DateTime?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, isViewed])
}

model ScreenTimePattern {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime // Normalized to start of day
  appName           String
  totalMinutes      Int      @default(0)
  sessionCount      Int      @default(0)
  longestSession    Int      @default(0) // Minutes
  isDoomscroll      Boolean  @default(false)
  scrollVelocity    Float?   // Average scroll speed
  interactionRate   Float?   // Clicks/swipes per minute
  timeOfDay         String?  // MORNING, AFTERNOON, EVENING, NIGHT
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, date, appName])
  @@index([userId, date])
  @@index([userId, isDoomscroll])
}

model DailyActivity {
  id                 String   @id @default(uuid())
  userId             String
  date               DateTime // Normalized to start of day
  flashcardsReviewed Int      @default(0)
  studyTime          Int      @default(0) // Minutes
  topicsStudied      Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

model Intervention {
  id              String   @id @default(uuid())
  userId          String
  triggerReason   String   // DOOMSCROLL_DETECTED, IDLE_TIME, MANUAL
  detectedApp     String   // App where doomscrolling was detected
  status          String   @default("PENDING") // PENDING, ACCEPTED, DISMISSED, EXPIRED
  contentType     String?  // FLASHCARD, TOPIC, CAPTURE, ARTICLE
  contentId       String?  // ID of the suggested content
  contentPreview  String?  // Short preview of the content
  triggeredAt     DateTime @default(now())
  respondedAt     DateTime?
  expiresAt       DateTime // Auto-expire after 5 minutes
  metadata        String?  // JSON: additional context
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, status])
  @@index([userId, triggeredAt])
  @@index([status, expiresAt])
}

model EssentialSpaceItem {
  id          String   @id @default(uuid())
  userId      String
  itemType    String   // FLASHCARD, GOAL, CAPTURE, MEMORY, STREAK, ACHIEVEMENT
  itemId      String?  // Reference to the actual item
  title       String
  description String?
  priority    String   // URGENT, IMPORTANT, NICE_TO_HAVE
  score       Float    // Calculated priority score
  metadata    String?  // JSON: additional context
  shownAt     DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([userId, shownAt])
  @@index([userId, itemType])
}

model EssentialSpaceFeedback {
  id          String   @id @default(uuid())
  userId      String
  itemId      String   // Reference to EssentialSpaceItem
  itemType    String   // Same as EssentialSpaceItem.itemType
  rating      Int      // 1-5 stars
  feedback    String?  // Optional text feedback
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([itemType])
  @@index([userId, createdAt])
}

model FocusSession {
  id              String   @id @default(uuid())
  userId          String
  duration        Int      // Planned duration in minutes
  actualDuration  Int?     // Actual duration completed in minutes
  topic           String?  // What they're focusing on
  allowedApps     String   // JSON array of allowed apps
  blockedApps     String   // JSON array of blocked apps
  status          String   @default("ACTIVE") // ACTIVE, COMPLETED, ABANDONED
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  interruptions   Int      @default(0)
  pomodoroCount   Int      @default(0) // Number of pomodoros completed
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([userId, status])
  @@index([startedAt])
  @@index([userId, startedAt])
}

model FocusInterruption {
  id              String   @id @default(uuid())
  sessionId       String
  appName         String   // App that was accessed
  timestamp       DateTime @default(now())
  handled         Boolean  @default(false) // Did user return to focus?
  createdAt       DateTime @default(now())

  @@index([sessionId])
  @@index([timestamp])
}

model FocusMode {
  id                String   @id @default(uuid())
  userId            String
  name              String   // e.g., "Deep Work", "Study Time"
  description       String?
  duration          Int      // Duration in minutes
  blockedApps       String   // JSON array of app identifiers
  allowedApps       String   // JSON array of app identifiers
  isActive          Boolean  @default(false)
  startedAt         DateTime?
  endedAt           DateTime?
  totalSessions     Int      @default(0)
  totalMinutes      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model ScreenUsageLog {
  id          String   @id @default(uuid())
  userId      String
  appName     String   // e.g., "Instagram", "Twitter", "VSCode"
  category    String?  // SOCIAL_MEDIA, PRODUCTIVITY, ENTERTAINMENT
  duration    Int      // Seconds
  timestamp   DateTime @default(now())
  metadata    String?  // JSON: additional context (scroll distance, interactions)
  createdAt   DateTime @default(now())

  @@index([userId, timestamp])
  @@index([userId, appName])
  @@index([timestamp])
}

model DoomscrollEvent {
  id                String   @id @default(uuid())
  userId            String
  appName           String
  startedAt         DateTime
  endedAt           DateTime?
  duration          Int?     // Minutes
  scrollDistance    Float?   // Estimated pixels scrolled
  itemsViewed       Int?     // Estimated content items
  interventionId    String?  // If intervention was triggered
  wasInterrupted    Boolean  @default(false)
  createdAt         DateTime @default(now())

  @@index([userId])
  @@index([userId, startedAt])
}

model InterventionSuccess {
  id                String   @id @default(uuid())
  userId            String
  ruleId            String   // Reference to InterventionRule
  triggeredAt       DateTime @default(now())
  wasSuccessful     Boolean  @default(false)
  userAction        String?  // ACCEPTED, DISMISSED, IGNORED
  timeToAction      Int?     // Seconds until user responded
  contextBefore     String?  // JSON: state before intervention
  contextAfter      String?  // JSON: state after intervention
  createdAt         DateTime @default(now())

  @@index([userId])
  @@index([ruleId])
  @@index([userId, triggeredAt])
  @@index([createdAt])
}

model ScreenTimeEvent {
  id              String   @id @default(uuid())
  userId          String
  timestamp       DateTime @default(now())
  appPackageName  String
  sessionDuration Int      // Milliseconds
  interactionCount Int
  scrollDistance  Int
  contextSwitches Int
  timeOfDay       String   // MORNING, AFTERNOON, EVENING, NIGHT
  dayType         String   // WEEKDAY, WEEKEND
  batteryLevel    Int
  location        String?
  createdAt       DateTime @default(now())


  @@index([userId, timestamp])
  @@index([timestamp])
}

model Module {
  id             String   @id @default(uuid())
  curriculumId   String
  name           String
  order          Int
  estimatedHours Float
  
  curriculum     Curriculum @relation(fields: [curriculumId], references: [id])
  topics         Topic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subtopic {
  id               String   @id @default(uuid())
  topicId          String
  name             String
  order            Int
  estimatedMinutes Int
  keyPoints        String   
  
  topic            Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  
  userMastery      UserMastery[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TopicDependency {
  id          String   @id @default(uuid())
  fromTopicId String
  toTopicId   String
  strength    String   @default("REQUIRED")

  fromTopic   Topic    @relation("Dependents", fields: [fromTopicId], references: [id], onDelete: Cascade)
  toTopic     Topic    @relation("Prerequisites", fields: [toTopicId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([fromTopicId, toTopicId])
  @@index([fromTopicId])
  @@index([toTopicId])
}

model Curriculum {
  id        String   @id @default(uuid())
  userId    String
  subject   String
  examType  String   @default("GENERAL")
  metadata  String?  
  
  modules   Module[]
  studyPlans StudyPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StudyPlan {
  id           String   @id @default(uuid())
  userId       String
  curriculumId String
  startDate    DateTime
  targetDate   DateTime
  schedule     String   
  status       String   @default("ACTIVE")

  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DailyContent {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  sections  String   
  metrics   String?  
  
  createdAt DateTime @default(now())
  
  @@unique([userId, date])
  @@index([userId])
}

model Quiz {
  id           String   @id @default(uuid())
  topicId      String
  bloomsLevel  String?
  difficulty   Int      @default(1)
  totalPoints  Int      @default(0)
  
  topic        Topic            @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions    QuizQuestion[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model QuizQuestion {
  id              String   @id @default(uuid())
  quizId          String
  question        String
  type            String   @default("MCQ")
  options         String   
  correctAnswer   String   
  explanation     String?  
  difficulty      Int
  bloomsLevel     String
  
  quiz            Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UserMastery {
  id          String   @id @default(uuid())
  userId      String
  subtopicId  String
  level       Int      @default(0)
  confidence  Float    @default(0.0)
  lastPracticed DateTime?
  
  // Spaced Repetition / Retention
  retention            String?   // JSON: current retention probability curves
  difficultyProgression String?  // JSON: history of difficulty adjustments
  metrics              String?   // JSON: fine-grained metrics
  lastReviewDate       DateTime?
  nextReviewDate       DateTime? 
  
  subtopic    Subtopic @relation(fields: [subtopicId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, subtopicId])
  @@index([userId])
  @@index([nextReviewDate]) // For scheduler
  @@index([userId, nextReviewDate])
}

model OfflineSyncLog {
  id              String   @id @default(uuid())
  userId          String
  entityType      String   // REVIEW_LOG, QUIZ_ATTEMPT, PROGRESS
  entityId        String
  action          String   // CREATE, UPDATE, DELETE
  clientTimestamp DateTime
  serverTimestamp DateTime @default(now())
  status          String   @default("PROCESSED") // PROCESSED, CONFLICT, ERROR
  metadata        String?  // JSON

  @@index([userId, clientTimestamp])
  @@index([userId, status])
}

// --- PART 5: Challenge Engine & TrueSkill Matchmaking ---

model ChallengeRating {
  userId    String
  topicId   String  
  mu        Float   @default(25.0)  // TrueSkill skill rating
  sigma     Float   @default(8.333) // Uncertainty
  games     Int     @default(0)
  
  @@id([userId, topicId])
  @@index([topicId, mu])
}

model ChallengeMatch {
  id            String   @id @default(uuid())
  challengerId  String
  opponentId    String  
  topicId       String
  status        String   @default("PENDING") // PENDING, ACTIVE, COMPLETED, EXPIRED
  questionCount Int
  timeLimit     Int      // seconds
  content       String   // JSON: questions
  createdAt     DateTime @default(now())
  expiresAt     DateTime
  startedAt     DateTime?
  completedAt   DateTime?
  
  results       ChallengeResult[]
  
  @@index([challengerId])
  @@index([opponentId])
  @@index([status])
}

model ChallengeResult {
  id          String   @id @default(uuid())
  matchId     String
  userId      String
  score       Float    // 0.0-1.0 (accuracy * 0.7 + speed * 0.3)
  answers     String   // JSON
  metadata    String?
  submittedAt DateTime @default(now())
  
  match       ChallengeMatch @relation(fields: [matchId], references: [id], onDelete: Cascade)
  
  @@index([matchId])
  @@index([userId])
}

// --- PART 5: Social Graph & Verifiable Results ---

model SocialGraph {
  id         String   @id @default(uuid())
  followerId String
  targetId   String
  topics     String[] // Topic-specific follows
  createdAt  DateTime @default(now())
  
  @@unique([followerId, targetId])
  @@index([targetId])
  @@index([followerId])
}

model PrivacySettings {
  userId                String   @id
  profileVisibility     String   @default("PUBLIC") // PUBLIC, FOLLOWERS, PRIVATE
  showMockResults       String   @default("FOLLOWERS")
  showChallengeHistory  String   @default("NOBODY")
  showStreak            String   @default("PUBLIC")
  whoCanFollow          String   @default("ANYONE")
  allowFollowerNotif    Boolean  @default(true)
  updatedAt             DateTime @updatedAt
}

model BlockList {
  userId    String
  blockedId String
  createdAt DateTime @default(now())
  
  @@id([userId, blockedId])
  @@index([userId])
}

model SharedResult {
  shareId     String   @id @default(uuid())
  resultId    String
  resultType  String   // CHALLENGE, MOCK_TEST, ACHIEVEMENT
  visibility  String   // PUBLIC, UNLISTED
  accessCount Int      @default(0)
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  
  @@index([resultId])
  @@index([shareId])
}

model ResultProof {
  id            String   @id @default(uuid())
  resultId      String   @unique
  userId        String
  merkleRoot    String
  proofData     String   // JSON: ZK proof metadata
  integrityCheck String  // Verification checksum
  verified      Boolean  @default(true)
  createdAt     DateTime @default(now())
  
  @@index([userId])
}

// --- PART 5: Mock Test Competitions & Anti-Cheat ---

model MockTest {
  id             String   @id @default(uuid())
  userId         String
  topicId        String
  difficulty     String   // EASY, MEDIUM, HARD
  questionCount  Int
  timeLimit      Int      // minutes
  questions      String   // JSON (encrypted)
  integrityHash  String
  status         String   @default("ACTIVE") // ACTIVE, COMPLETED, INVALID
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  
  result         MockTestResult?
  
  @@index([userId])
  @@index([topicId])
  @@index([status])
}

model MockTestResult {
  id             String   @id @default(uuid())
  testId         String   @unique
  userId         String
  topicId        String
  score          Float    // IRT-weighted score
  percentile     Float
  globalRank     Int?
  integrityScore Float    @default(1.0) // 1.0 = clean
  answers        String   // JSON
  metadata       String?  // {tabSwitches, flags, violations}
  submittedAt    DateTime @default(now())
  
  test           MockTest @relation(fields: [testId], references: [id], onDelete: Cascade)
  
  @@index([topicId, score])
  @@index([userId])
  @@index([userId, topicId])
}

model MockTestLeaderboard {
  id          String   @id @default(uuid())
  topicId     String
  anonId      String   // Hash of userId for privacy
  score       Float
  percentile  Float
  rank        Int
  submittedAt DateTime @default(now())
  
  @@index([topicId, score])
  @@index([topicId, rank])
}

// --- PART 5: Feed Engine & Recommendations ---

model FeedItem {
  id          String   @id @default(uuid())
  creatorId   String
  itemType    String   // CHALLENGE_RESULT, MOCK_TEST, ACHIEVEMENT, TIP, QUESTION
  content     String   // JSON
  topics      String[] // Array of topic IDs
  createdAt   DateTime @default(now())
  
  impressions FeedImpression[]
  
  @@index([createdAt])
  @@index([itemType])
}

model UserFeedState {
  userId            String   @id
  lastSeenItemId    String?
  dismissedTopics   String[] 
  feedPreferences   String   // JSON: {showChallenges: true, ...}
  updatedAt         DateTime @updatedAt
}

model FeedImpression {
  id         String   @id @default(uuid())
  userId     String
  itemId     String
  action     String   // VIEWED, CLICKED, DISMISSED
  timestamp  DateTime @default(now())
  
  item       FeedItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@index([userId, timestamp])
  @@index([itemId])
}


